









# Example configuration entry
#web_server:
#  port: 80


# Enable logging
logger:
  level: DEBUG


uart:
  id: uart_bus
  rx_pin: GPIO19
#  tx_pin: ${tx_pin}
  baud_rate: 9600
  data_bits: 8
  parity: NONE
  stop_bits: 1
  rx_buffer_size: 512

# =========================
# SENSORS
# =========================

sensor:

  # --- 16 CELL VOLTAGES ---
  - platform: template
    name: "Cell 1"
    id: cell_1
    unit_of_measurement: "V"
    accuracy_decimals: 3
    state_class: measurement

  - platform: template
    name: "Cell 2"
    id: cell_2
    unit_of_measurement: "V"
    accuracy_decimals: 3
    state_class: measurement

  - platform: template
    name: "Cell 3"
    id: cell_3
    unit_of_measurement: "V"
    accuracy_decimals: 3
    state_class: measurement

  - platform: template
    name: "Cell 4"
    id: cell_4
    unit_of_measurement: "V"
    accuracy_decimals: 3
    state_class: measurement

  - platform: template
    name: "Cell 5"
    id: cell_5
    unit_of_measurement: "V"
    accuracy_decimals: 3
    state_class: measurement

  - platform: template
    name: "Cell 6"
    id: cell_6
    unit_of_measurement: "V"
    accuracy_decimals: 3
    state_class: measurement

  - platform: template
    name: "Cell 7"
    id: cell_7
    unit_of_measurement: "V"
    accuracy_decimals: 3
    state_class: measurement

  - platform: template
    name: "Cell 8"
    id: cell_8
    unit_of_measurement: "V"
    accuracy_decimals: 3
    state_class: measurement

  - platform: template
    name: "Cell 9"
    id: cell_9
    unit_of_measurement: "V"
    accuracy_decimals: 3
    state_class: measurement

  - platform: template
    name: "Cell 10"
    id: cell_10
    unit_of_measurement: "V"
    accuracy_decimals: 3
    state_class: measurement

  - platform: template
    name: "Cell 11"
    id: cell_11
    unit_of_measurement: "V"
    accuracy_decimals: 3
    state_class: measurement

  - platform: template
    name: "Cell 12"
    id: cell_12
    unit_of_measurement: "V"
    accuracy_decimals: 3
    state_class: measurement

  - platform: template
    name: "Cell 13"
    id: cell_13
    unit_of_measurement: "V"
    accuracy_decimals: 3
    state_class: measurement

  - platform: template
    name: "Cell 14"
    id: cell_14
    unit_of_measurement: "V"
    accuracy_decimals: 3
    state_class: measurement

  - platform: template
    name: "Cell 15"
    id: cell_15
    unit_of_measurement: "V"
    accuracy_decimals: 3
    state_class: measurement

  - platform: template
    name: "Cell 16"
    id: cell_16
    unit_of_measurement: "V"
    accuracy_decimals: 3
    state_class: measurement


  # --- PACK VALUES ---
  - platform: template
    name: "Battery Voltage"
    id: battery_voltage
    unit_of_measurement: "V"
    accuracy_decimals: 2
    device_class: voltage
    state_class: measurement

  - platform: template
    name: "Aferiy SOC"
    id: aferiy_soc
    unit_of_measurement: "%"
    state_class: measurement

  - platform: template
    name: "Battery Current"
    id: battery_current
    unit_of_measurement: "A"
    accuracy_decimals: 2
    device_class: current
    state_class: measurement

  - platform: template
    name: "Battery Power"
    id: battery_power
    unit_of_measurement: "W"
    accuracy_decimals: 1
    device_class: power
    state_class: measurement

  - platform: template
    name: "Battery Delta"
    id: delta_cell
    unit_of_measurement: "V"
    accuracy_decimals: 3
    state_class: measurement

  - platform: template
    name: "Battery Min Cell"
    id: battery_min_cell
    unit_of_measurement: "V"
    accuracy_decimals: 3
    force_update: true
    icon: "mdi:battery-arrow-down"
  - platform: template
    name: "Battery Max Cell"
    id: battery_max_cell
    unit_of_measurement: "V"
    accuracy_decimals: 3
    icon: "mdi:battery-arrow-up"


# =========================
# BINARY SENSORS
# =========================

binary_sensor:
  - platform: template
    name: "BMS Overvoltage"
    id: alarm_ov

  - platform: template
    name: "BMS Undervoltage"
    id: alarm_uv

  - platform: template
    name: "Balancing Active"
    id: balancing_active


# =========================
# FRAME PARSER
# =========================

interval:
  - interval: 200ms
    then:
      - lambda: |-
          static std::vector<uint8_t> buffer;
          static float last_soc = -1; 

          while (id(uart_bus).available()) {
            uint8_t b;
            id(uart_bus).read_byte(&b);
            buffer.push_back(b);
            if (buffer.size() > 512) buffer.erase(buffer.begin());
          }

          if (buffer.size() < 60) return;

          for (size_t i = 0; i + 50 < buffer.size(); i++) {
            // Шукаємо пакет комірок
            if (buffer[i] == 0x11 && buffer[i+1] == 0x04) {
              
              int start = i + 6; // У Sydpower дані йдуть після 6-го байта
              
              // Функція читання Big Endian (Старший байт першим)
              auto get_v = [&](int idx) {
                return ((uint16_t(buffer[idx]) << 8) | buffer[idx+1]) / 1000.0;
              };

              float cells[16];
              float total_v = 0;
              
              // Зчитуємо комірки
              for (int c = 0; c < 16; c++) {
                cells[c] = get_v(start + c*2);
              }

              // Валідація: якщо перша комірка не в межах 2-4В, це "сміття"
              if (cells[0] < 2.0 || cells[0] > 4.5) continue;

              float min_v = cells[0];
              float max_v = cells[0];

              for (int c = 0; c < 16; c++) {
                total_v += cells[c];
                if (cells[c] < min_v) min_v = cells[c];
                if (cells[c] > max_v) max_v = cells[c];
                
                // Публікуємо напругу кожної комірки динамічно
                if (c == 0) id(cell_1).publish_state(cells[0]);
                else if (c == 1) id(cell_2).publish_state(cells[1]);
                else if (c == 2) id(cell_3).publish_state(cells[2]);
                else if (c == 3) id(cell_4).publish_state(cells[3]);
                else if (c == 4) id(cell_5).publish_state(cells[4]);
                else if (c == 5) id(cell_6).publish_state(cells[5]);
                else if (c == 6) id(cell_7).publish_state(cells[6]);
                else if (c == 7) id(cell_8).publish_state(cells[7]);
                else if (c == 8) id(cell_9).publish_state(cells[8]);
                else if (c == 9) id(cell_10).publish_state(cells[9]);
                else if (c == 10) id(cell_11).publish_state(cells[10]);
                else if (c == 11) id(cell_12).publish_state(cells[11]);
                else if (c == 12) id(cell_13).publish_state(cells[12]);
                else if (c == 13) id(cell_14).publish_state(cells[13]);
                else if (c == 14) id(cell_15).publish_state(cells[14]);
                else if (c == 15) id(cell_16).publish_state(cells[15]);
              }

              // Публікуємо розрахунки
              id(battery_min_cell).publish_state(min_v);
              id(battery_max_cell).publish_state(max_v);
              id(delta_cell).publish_state(max_v - min_v);
              id(battery_voltage).publish_state(total_v);

              // СТРУМ (Current)
              int16_t current_raw = (int16_t)((buffer[start+38] << 8) | buffer[start+39]);
              float current = current_raw / 100.0;
              id(battery_current).publish_state(current);
              id(battery_power).publish_state(total_v * current);

              // БАЛАНСУВАННЯ ТА АЛАРМИ
              uint16_t balance_mask = (buffer[start+36] << 8) | buffer[start+37];
              id(balancing_active).publish_state(balance_mask != 0);



              buffer.clear();
              return;
            }
          }
